trigger:
- main

pool: linux-pool

variables:
  appName: 'JavaLoginShowcase'
  artifactName: 'javalogin'
  warFileName: '*.war'
  jdkVersion: '1.8'
  tomcatHome: '/opt/tomcat'
  deployFolder: '/opt/tomcat/webapps'


###################  BUILD STAGE  ###################
stages:
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: MavenBuild
    displayName: "Compile & Package WAR"
    steps:
    - task: Bash@3
      displayName: "Run Maven Package"
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)
          mvn clean package

    - task: PublishPipelineArtifact@1
      displayName: "Publish WAR Artifact"
      inputs:
        targetPath: "$(System.DefaultWorkingDirectory)/target"
        artifact: "$(artifactName)"
        publishLocation: "pipeline"


# ###################  DEPLOY STAGE  ###################
# - stage: Deploy
#   displayName: "Deploy to Tomcat Server"
#   dependsOn: Build
#   jobs:
#   - job: DeployJob
#     displayName: "Deploy WAR via SSH"
#     steps:

#     - task: DownloadPipelineArtifact@2
#       displayName: "Download WAR Artifact"
#       inputs:
#         artifactName: "$(artifactName)"
#         targetPath: "$(Pipeline.Workspace)/$(artifactName)"

#     - script: |
#         echo "Artifact structure:"
#         ls -R $(Pipeline.Workspace)/$(artifactName)
#       displayName: "Verify Artifact"

#     - task: CopyFilesOverSSH@0
#       displayName: "Copy WAR to Remote Tomcat"
#       inputs:
#         sshEndpoint: "linux"   # MUST match your service connection name
#         sourceFolder: "$(Pipeline.Workspace)/$(artifactName)"
#         contents: "$(warFileName)"
#         targetFolder: "$(deployFolder)"
#         readyTimeout: "20000"

#     - task: SSH@0
#       displayName: "Restart Tomcat"
#       inputs:
#         sshEndpoint: "linux"
#         runOptions: "commands"
#         commands: |
#           sudo systemctl restart tomcat
#           sudo systemctl status tomcat --no-pager || true

- stage: Deploy
  displayName: "Deploy to Tomcat Server"
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: "Deploy WAR via SSH"
    steps:

    - task: DownloadPipelineArtifact@2
      displayName: "Download WAR Artifact"
      inputs:
        artifactName: "$(artifactName)"
        targetPath: "$(Pipeline.Workspace)/$(artifactName)"

    - script: |
        echo "Artifact Content:"
        ls -R $(Pipeline.Workspace)/$(artifactName)
      displayName: "Verify Artifact"

    - task: CopyFilesOverSSH@0
      displayName: "Copy WAR to /tmp/deploy"
      inputs:
        sshEndpoint: "linux"
        sourceFolder: "$(Pipeline.Workspace)/$(artifactName)"
        contents: "$(warFileName)"
        # targetFolder: "/tmp/deploy"
        targetFolder: "/home/azureuser/deploy"
        readyTimeout: "20000"

    - task: SSH@0
      displayName: "Move WAR & Restart Tomcat"
      inputs:
        sshEndpoint: "linux"
        runOptions: "commands"
        commands: |
          echo "Creating deploy directory if not exists..."
          #sudo mkdir -p /tmp/deploy

          echo "Moving WAR to Tomcat webapps folder..."
          sudo mv /home/azureuser/deploy/*.war /opt/tomcat/webapps/

          echo "Restarting Tomcat..."
          sudo systemctl restart tomcat

          echo "Tomcat status:"
          sudo systemctl status tomcat --no-pager || true

